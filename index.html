<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#05070a" />
  <title>NEON ALLEY — Hybrid Overworld Prototype</title>

  <!-- PWA optional: wenn du manifest/webmanifest hast -->
  <link rel="manifest" href="./manifest.webmanifest">
  <style>
    :root{
      --bg:#05070a;
      --panel:rgba(8,12,18,.86);
      --cyan:#00f3ff;
      --pink:#ff007c;
      --yellow:#fcee0a;
      --muted:#8aa0b3;
      --line:rgba(0,243,255,.18);
      --shadowC:0 0 18px rgba(0,243,255,.25);
      --shadowP:0 0 18px rgba(255,0,124,.2);
      --font: ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{margin:0;height:100%;background:var(--bg);color:#fff;font-family:var(--font);overflow:hidden}
    #app{position:relative;height:100%}
    canvas{position:absolute;inset:0;display:block}
    #threeCanvas{z-index:1; touch-action:none;} /* Canvas muss Touch bekommen für Raycast/Movement */
    #ui{position:absolute;inset:0;z-index:10;pointer-events:none;} /* Panels setzen pointer-events:auto */

    /* Scanlines / glow */
    #ui::before{
      content:"";position:absolute;inset:0;pointer-events:none;
      background:repeating-linear-gradient(to bottom, rgba(255,255,255,.02) 0 1px, transparent 2px 4px);
      opacity:.28;mix-blend-mode:screen;
    }

    .panel{
      background:linear-gradient(180deg, rgba(10,16,24,.92), rgba(5,9,14,.92));
      border:1px solid rgba(0,243,255,.28);
      box-shadow:var(--shadowC);
      clip-path:polygon(0 0, calc(100% - 14px) 0, 100% 14px, 100% 100%, 14px 100%, 0 calc(100% - 14px));
    }
    .panelPink{
      border-color:rgba(255,0,124,.28);
      box-shadow:var(--shadowP);
    }
    .btn{
      pointer-events:auto;
      border:1px solid rgba(0,243,255,.55);
      color:var(--cyan);
      background:rgba(0,0,0,.25);
      padding:10px 12px;
      font-weight:800;
      font-family:var(--font);
      text-transform:uppercase;
      letter-spacing:1px;
      cursor:pointer;
    }
    .btn:hover,.btn:active{background:rgba(0,243,255,.14)}
    .btn.pink{border-color:rgba(255,0,124,.6);color:var(--pink)}
    .btn.yellow{border-color:rgba(252,238,10,.6);color:var(--yellow)}
    .muted{color:var(--muted)}
    .tiny{font-size:11px}

    /* Title */
    #title{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      pointer-events:auto;
      background:
        radial-gradient(circle at 50% 35%, rgba(255,180,90,.08), transparent 42%),
        linear-gradient(180deg, rgba(9,14,22,.55), rgba(3,4,7,.92));
    }
    #card{width:min(620px,92vw);padding:16px}
    #logo{font-size:34px;font-weight:900;letter-spacing:6px;color:var(--cyan);text-shadow:0 0 18px rgba(0,243,255,.55)}
    #sub{color:var(--pink);font-size:12px;letter-spacing:2px;margin-top:4px}
    #desc{margin-top:12px;font-size:12px;line-height:1.55;color:#cfe0eb}
    #actions{margin-top:14px;display:flex;gap:8px;flex-wrap:wrap}
    #actions .btn{flex:1;min-width:160px}

    /* HUD */
    #hudTop{
      position:absolute;top:8px;left:8px;right:8px;
      display:flex;gap:8px;align-items:stretch;
      pointer-events:none;
    }
    .hudBox{
      pointer-events:none;
      background:linear-gradient(180deg, rgba(8,14,20,.9), rgba(4,7,11,.9));
      border:1px solid rgba(0,243,255,.22);
      box-shadow:var(--shadowC);
      padding:8px 10px;
      min-width:0;
    }
    .hudBox .k{font-size:10px;color:var(--muted);letter-spacing:1px}
    .hudBox .v{font-size:13px;font-weight:900}

    /* Left panel */
    #left{
      position:absolute;left:10px;top:56px;bottom:10px;width:min(360px,90vw);
      display:flex;flex-direction:column;gap:8px;
      pointer-events:none;
    }
    #route, #dialog, #missionPanel{
      pointer-events:auto;
      padding:12px;
    }
    #routeTitle{font-weight:900;letter-spacing:1px;color:var(--cyan)}
    #routeList{margin-top:10px;display:flex;flex-direction:column;gap:8px;max-height:34vh;overflow:auto}
    .nodeCard{
      border:1px solid rgba(0,243,255,.18);
      background:rgba(255,255,255,.02);
      padding:8px;
      display:grid;grid-template-columns:1fr auto;gap:8px;
      align-items:center;
    }
    .nodeCard.active{border-color:rgba(255,0,124,.35)}
    .badge{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid rgba(255,255,255,.16)}
    .badge.mission{border-color:rgba(0,243,255,.35);color:var(--cyan)}
    .badge.npc{border-color:rgba(255,0,124,.35);color:var(--pink)}
    .badge.locked{border-color:rgba(255,255,255,.1);color:#777}

    /* Dialog */
    #dialog{display:none}
    #dialogHead{display:flex;align-items:center;gap:10px}
    #holo{
      width:48px;height:48px;border:1px solid rgba(0,243,255,.35);
      background:
        radial-gradient(circle at 65% 30%, rgba(255,255,255,.5), transparent 35%),
        radial-gradient(circle at 50% 50%, rgba(0,243,255,.16), transparent 70%),
        linear-gradient(180deg, rgba(255,0,124,.18), rgba(0,0,0,.2));
      position:relative;overflow:hidden;
    }
    #holo::after{
      content:"";position:absolute;inset:0;
      background:repeating-linear-gradient(to bottom, rgba(255,255,255,.07) 0 1px, transparent 2px 4px);
      opacity:.5;animation:scan 2s linear infinite;
    }
    @keyframes scan{from{transform:translateY(-100%)}to{transform:translateY(100%)}}
    #npcName{font-weight:900;color:var(--pink);letter-spacing:1px}
    #npcRole{font-size:10px;color:var(--muted)}
    #dialogText{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.15);
      padding:10px;
      font-size:12px;line-height:1.5;color:#d7e5ef;
      max-height:18vh;overflow:auto;
    }
    #choices{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .choice{pointer-events:auto}
    .choice.btn{text-align:left;font-size:12px}

    /* Mission overlay */
    #missionOverlay{
      position:absolute;inset:0;display:none;
      z-index:20;
      background:rgba(0,0,0,.68);
      pointer-events:auto;
      align-items:center;justify-content:center;
    }
    #missionCard{width:min(620px,92vw);padding:14px}
    #missionCanvas{
      width:100%;height:52vh;max-height:520px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(0,243,255,.25);
      display:block;
      touch-action:none;
    }
    #missionRow{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    #missionRow .btn{flex:1;min-width:160px}

    /* Bottom hint */
    #bottom{
      position:absolute;left:10px;right:10px;bottom:10px;
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
      pointer-events:none;
    }
    #ticker{
      pointer-events:auto;
      flex:1;min-width:220px;padding:10px;
      border:1px solid rgba(255,0,124,.28);
      background:rgba(255,0,124,.04);
      box-shadow:var(--shadowP);
      font-size:11px;color:#ffd7ea;
    }
    #ticker b{color:var(--pink)}
    .small{padding:8px 10px;font-size:11px}

    /* Mobile layout */
    @media (max-width:920px){
      #left{left:8px;right:8px;width:auto;top:auto;bottom:62px;max-height:44vh}
      #routeList{max-height:18vh}
    }
  </style>
</head>

<body>
<div id="app">
  <canvas id="threeCanvas"></canvas>

  <div id="ui">
    <!-- Title -->
    <div id="title">
      <div id="card" class="panel">
        <div id="logo">NEON ALLEY</div>
        <div id="sub">HYBRID OVERWORLD // NPCs // FRONTLINE MISSIONS</div>
        <div id="desc">
          Du startest „clean“ am Tag. Je mehr Missionen du ziehst, desto dreckiger kippt die Stadt Richtung Sunset.
          Klick/Tap auf Nodes für Missionen, geh zu NPC-Hotspots für Story-Fragmente + Upgrades.
          <div class="tiny muted" style="margin-top:10px">
            Steuerung: <b>Drag</b> auf der Stadt = bewegen · <b>Tap</b> auf Kugeln = interagieren ·
            <b>Mission</b> startet Arcade „Frontline“ (kein Breach).
          </div>
        </div>
        <div id="actions">
          <button class="btn yellow" id="btnStart">Enter Night City</button>
          <button class="btn" id="btnLoad">Load Save</button>
          <button class="btn pink" id="btnReset">Reset</button>
        </div>
      </div>
    </div>

    <!-- HUD -->
    <div id="hudTop">
      <div class="hudBox" style="flex:1.2">
        <div class="k">DISTRICT</div>
        <div class="v" id="hudDistrict">Sector-07</div>
      </div>
      <div class="hudBox">
        <div class="k">EDDIES</div>
        <div class="v" id="hudMoney">E$ 0</div>
      </div>
      <div class="hudBox">
        <div class="k">FRAGS</div>
        <div class="v" id="hudFrags">0</div>
      </div>
      <div class="hudBox">
        <div class="k">HEAT</div>
        <div class="v" id="hudHeat">0%</div>
      </div>
      <div class="hudBox">
        <div class="k">TIME</div>
        <div class="v" id="hudTime">DAY</div>
      </div>
    </div>

    <!-- Left panel -->
    <div id="left">
      <div id="route" class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <div id="routeTitle">OVERWORLD // ROUTE NODES</div>
            <div class="tiny muted">Tippe Nodes in 3D oder wähle hier.</div>
          </div>
          <button class="btn small" id="btnSave">Save</button>
        </div>
        <div class="tiny" id="routeTag" style="margin-top:8px;border-left:2px solid rgba(255,0,124,.35);padding-left:8px;color:#c8d7e2">
          Früher Tag. Die Stadt ist zu sauber, um echt zu sein.
        </div>
        <div id="routeList"></div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn small yellow" id="btnFocusPlayer">Focus</button>
          <button class="btn small" id="btnExport">Export</button>
          <button class="btn small" id="btnImport">Import</button>
        </div>
        <textarea id="io" class="panel" style="margin-top:10px;width:100%;height:66px;padding:8px;border:1px solid rgba(0,243,255,.18);background:rgba(0,0,0,.25);color:#d8faff;pointer-events:auto" placeholder="Save JSON"></textarea>
      </div>

      <div id="dialog" class="panel panelPink">
        <div id="dialogHead">
          <div id="holo"></div>
          <div>
            <div id="npcName">NYX</div>
            <div id="npcRole">Fixer // Encrypted VOIP</div>
          </div>
          <div style="margin-left:auto">
            <button class="btn small" id="btnCloseDialog">X</button>
          </div>
        </div>
        <div id="dialogText"></div>
        <div id="choices"></div>
      </div>
    </div>

    <!-- Mission overlay -->
    <div id="missionOverlay">
      <div id="missionCard" class="panel panelPink">
        <div style="font-weight:900;letter-spacing:2px;color:var(--pink)">FRONTLINE // ARENA</div>
        <div class="tiny muted" id="missionHint" style="margin-top:6px">
          Tippe um zu schießen. Halte/drag links um zu bewegen. Sammle Frags, bevor Heat dich einholt.
        </div>
        <canvas id="missionCanvas" width="900" height="520"></canvas>
        <div id="missionRow">
          <button class="btn yellow" id="btnMissionExit">Back to City</button>
          <button class="btn" id="btnMissionRetry">Retry</button>
        </div>
      </div>
    </div>

    <!-- Bottom -->
    <div id="bottom">
      <div id="ticker" class="panelPink">
        <b>NYX:</b> “Choom. Overworld first. Dann Frontline. Und wenn Arasaka aufwacht… rennen wir nicht. Wir <i>lenken</i>.”
      </div>
      <button class="btn small" id="btnTalkNyx" style="pointer-events:auto">Call Nyx</button>
      <button class="btn small pink" id="btnTalkGhost" style="pointer-events:auto">Ping Ghost</button>
    </div>

  </div>
</div>

<script type="module">
  import * as THREE from './three.module.js';

  // --------- State ----------
  const DEFAULT_SAVE = {
    v: 1,
    money: 0,
    frags: 0,
    heat: 0,         // 0..100
    progress: 0,     // 0..1
    district: 0,
    unlocked: { n0:true, n1:true, n2:false, n3:false, n4:false, n5:false },
    story: [],
    trust: { nyx: 0, ghost: 0 },
    player: { x: 0, z: 0 },
    seed: Math.floor(Math.random()*1e9)
  };

  let S = loadSave() || structuredClone(DEFAULT_SAVE);

  // --------- UI refs ----------
  const elTitle = document.getElementById('title');
  const elHudDistrict = document.getElementById('hudDistrict');
  const elHudMoney = document.getElementById('hudMoney');
  const elHudFrags = document.getElementById('hudFrags');
  const elHudHeat = document.getElementById('hudHeat');
  const elHudTime = document.getElementById('hudTime');
  const elRouteList = document.getElementById('routeList');
  const elRouteTag = document.getElementById('routeTag');
  const elTicker = document.getElementById('ticker');
  const elIO = document.getElementById('io');

  const elDialog = document.getElementById('dialog');
  const elDialogText = document.getElementById('dialogText');
  const elChoices = document.getElementById('choices');
  const elNpcName = document.getElementById('npcName');
  const elNpcRole = document.getElementById('npcRole');

  const missionOverlay = document.getElementById('missionOverlay');
  const missionCanvas = document.getElementById('missionCanvas');
  const mctx = missionCanvas.getContext('2d');

  // --------- Buttons ----------
  document.getElementById('btnStart').onclick = () => {
    elTitle.style.display = 'none';
    tickMsg("NYX", "Du bist drin. Beweg dich. Tippe Nodes. Wir erzählen die Wahrheit in Stücken.");
  };
  document.getElementById('btnLoad').onclick = () => {
    const loaded = loadSave();
    if (loaded) { S = loaded; applySaveToWorld(); renderRoute(); hud(); tickMsg("SYSTEM","Save geladen."); }
    else tickMsg("SYSTEM","Kein Save gefunden.");
  };
  document.getElementById('btnReset').onclick = () => {
    S = structuredClone(DEFAULT_SAVE);
    saveNow();
    applySaveToWorld();
    renderRoute();
    hud();
    tickMsg("SYSTEM","Reset done.");
  };
  document.getElementById('btnSave').onclick = () => { saveNow(); tickMsg("SYSTEM","Saved."); };
  document.getElementById('btnExport').onclick = () => { elIO.value = JSON.stringify(S); elIO.focus(); tickMsg("SYSTEM","Export in Textfeld."); };
  document.getElementById('btnImport').onclick = () => {
    try{
      const obj = JSON.parse(elIO.value.trim());
      S = obj;
      saveNow();
      applySaveToWorld();
      renderRoute();
      hud();
      tickMsg("SYSTEM","Import OK.");
    }catch(e){
      tickMsg("SYSTEM","Import failed: JSON ungültig.");
    }
  };
  document.getElementById('btnFocusPlayer').onclick = () => focusPlayer();

  document.getElementById('btnCloseDialog').onclick = () => elDialog.style.display = 'none';
  document.getElementById('btnTalkNyx').onclick = () => openNpcDialog("nyx");
  document.getElementById('btnTalkGhost').onclick = () => openNpcDialog("ghost");

  document.getElementById('btnMissionExit').onclick = () => endMission(true);
  document.getElementById('btnMissionRetry').onclick = () => startMission(activeMissionNodeId);

  // --------- PWA (optional) ----------
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try { await navigator.serviceWorker.register('./sw.js'); } catch(e){}
    });
  }

  // --------- Overworld Three.js ----------
  const canvas = document.getElementById('threeCanvas');
  const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:false });
  renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
  renderer.setSize(innerWidth, innerHeight);
  renderer.setClearColor(0x05070a, 1);

  const scene = new THREE.Scene();
  scene.fog = new THREE.FogExp2(0x05070a, 0.035);

  const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 200);
  camera.position.set(0, 10, 14);

  const hemi = new THREE.HemisphereLight(0x66ccff, 0x220022, 0.9);
  scene.add(hemi);

  const dir = new THREE.DirectionalLight(0xffffff, 0.65);
  dir.position.set(6, 10, 4);
  scene.add(dir);

  // Ground
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(120, 120, 1, 1),
    new THREE.MeshStandardMaterial({ color: 0x06090d, roughness: 1, metalness: 0 })
  );
  ground.rotation.x = -Math.PI/2;
  ground.position.y = 0;
  scene.add(ground);

  // Neon grid
  const grid = new THREE.GridHelper(120, 60, 0x00f3ff, 0x112233);
  grid.material.opacity = 0.22;
  grid.material.transparent = true;
  scene.add(grid);

  // City blocks (cheap lowpoly)
  const city = new THREE.Group();
  scene.add(city);

  function rand(seed){
    // simple LCG
    seed = (seed * 1664525 + 1013904223) >>> 0;
    return seed / 4294967296;
  }
  function buildCity(){
    city.clear();
    let seed = S.seed >>> 0;
    const matA = new THREE.MeshStandardMaterial({ color: 0x0b0f14, roughness: 0.9, metalness: 0.05 });
    const matB = new THREE.MeshStandardMaterial({ color: 0x111824, roughness: 0.85, metalness: 0.08 });

    for(let i=0;i<180;i++){
      seed = (seed*1664525 + 1013904223)>>>0;
      const rx = (rand(seed)-0.5)*90; seed = (seed*1664525 + 1013904223)>>>0;
      const rz = (rand(seed)-0.5)*90; seed = (seed*1664525 + 1013904223)>>>0;

      // keep center playable
      if (Math.hypot(rx, rz) < 10) continue;

      const w = 0.8 + rand(seed)*2.2; seed = (seed*1664525 + 1013904223)>>>0;
      const d = 0.8 + rand(seed)*2.2; seed = (seed*1664525 + 1013904223)>>>0;
      const h = 0.8 + rand(seed)*7.5 * (0.6 + S.progress*0.7);

      const m = (i%2===0)?matA:matB;
      const b = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), m);
      b.position.set(rx, h/2, rz);
      city.add(b);

      // neon “windows”
      if (rand(seed) < 0.25){
        const neon = new THREE.Mesh(
          new THREE.BoxGeometry(w*1.02, 0.04, d*1.02),
          new THREE.MeshBasicMaterial({ color: (rand(seed)<0.5?0x00f3ff:0xff007c), transparent:true, opacity:0.35 })
        );
        neon.position.set(rx, h + 0.02, rz);
        city.add(neon);
      }
    }
  }

  // Player
  const player = new THREE.Mesh(
    new THREE.CapsuleGeometry(0.35, 0.7, 6, 10),
    new THREE.MeshStandardMaterial({ color: 0x00f3ff, roughness: 0.35, metalness: 0.3 })
  );
  player.position.set(S.player.x, 1.0, S.player.z);
  scene.add(player);

  // Nodes (missions + NPCs)
  const nodes = [
    { id:"n0", type:"npc", who:"nyx",  name:"NYX // Fixer",  pos:new THREE.Vector3(-6, 1, 2),  district:"Sector-07", locked:false },
    { id:"n1", type:"mission", tier:1, name:"Frontline: Alley Sweep", pos:new THREE.Vector3(4, 1, -2), district:"Sector-07", locked:false },
    { id:"n2", type:"npc", who:"ghost",name:"GHOST // Signal", pos:new THREE.Vector3(10,1, 7), district:"Market Sprawl", locked:true },
    { id:"n3", type:"mission", tier:2, name:"Frontline: Data Convoy", pos:new THREE.Vector3(-14,1, -12), district:"Market Sprawl", locked:true },
    { id:"n4", type:"mission", tier:3, name:"Frontline: Arasaka Pressure", pos:new THREE.Vector3(18,1, -16), district:"Arasaka Edge", locked:true },
    { id:"n5", type:"npc", who:"agent",name:"Saka-Handler // ???", pos:new THREE.Vector3(22,1, 2), district:"Arasaka Edge", locked:true }
  ];

  const nodeGroup = new THREE.Group();
  scene.add(nodeGroup);

  const nodeMeshes = new Map();
  function rebuildNodes(){
    nodeGroup.clear();
    nodeMeshes.clear();

    nodes.forEach((n, idx) => {
      const unlocked = !!S.unlocked[n.id];
      const col = n.type==="npc" ? 0xff007c : 0x00f3ff;
      const base = new THREE.Mesh(
        new THREE.SphereGeometry(0.45, 18, 12),
        new THREE.MeshStandardMaterial({ color: unlocked ? col : 0x333333, roughness:0.25, metalness:0.35 })
      );
      base.position.copy(n.pos);

      const ring = new THREE.Mesh(
        new THREE.TorusGeometry(0.7, 0.08, 10, 24),
        new THREE.MeshBasicMaterial({ color: unlocked ? col : 0x222222, transparent:true, opacity:0.55 }
